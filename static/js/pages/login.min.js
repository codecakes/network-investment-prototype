$(document).ready(function() {
	function getFormData($form) {
		var unindexed_array = $form.serializeArray();
		var indexed_array = {};

		$.map(unindexed_array, function(n, i) {
			indexed_array[n["name"]] = n["value"];
		});

		return indexed_array;
	}

	function loginFormAjax(event, data) {
        event.preventDefault();
        var block_element = $(event.target).closest(".card");
        block_element.block(block_options)
        $.ajax({
            type: "POST",
            url: "",
            data: data,
            success: function(data) {
                data = JSON.parse(data);
                block_element.unblock()
                if (data.status == "error") {
                    toastr.warning(data.message, "Error", toastr_options);
                } else {
                    $("#login_verification").addClass("hidden")
                    $("#forget_password_container").addClass("hidden")
                    $("#otp_verification").removeClass("hidden")
                    $("#otp_resend_container").removeClass("hidden")
                    //window.location = 'home'
                }
            }
        });
    }


    function otpLoginFormAjax(event, data) {
        event.preventDefault();
        var block_element = $(event.target).closest(".card");
        block_element.block(block_options)
        $.ajax({
            type: "GET",
            url: "",
            data: data,
            success: function(data) {
                //data = JSON.parse(data);
                //block_element.unblock()
                if (data.status == "error") {
                    toastr.warning(data.message, "Error", toastr_options);
                } else {
                    window.location = 'home'
                }
            }
        });
    }

	function registerFormAjax(event, data) {
		event.preventDefault();
		var block_element = $(event.target).closest(".card");
		block_element.block(block_options)
		$.ajax({
			type: "POST",
			url: "/signup/",
			data: data,
			success: function(data) {
				block_element.unblock()
				data = JSON.parse(data)
				if(data.status == "error") {
					toastr.warning(data.message, "Error", toastr_options);
				} else {
					toastr.success(data.message, "Success", toastr_options);
				}
			}
		});
	}

	function forgotPasswordAjax(event, data) {
		event.preventDefault();
		$.ajax({
			type: "POST",
			url: "",
			data: data,
			success: function(data) {
				data = JSON.parse(data)
				if (data.status == "error") {
					toastr.warning(data.message, "Error", toastr_options);
				} else if (data.status == "ok") {
					toastr.success(data.message, "Success", toastr_options);
				}
			}
		});
	}

	$("#placement_position").change(function() {
		if ($(this).val() == "R") {
			$("#placement_id_right").css("display", "block");
			$("#placement_id_left").css("display", "none");
		} else {
			$("#placement_id_right").css("display", "none");
			$("#placement_id_left").css("display", "block");
		}
	});

	$("#country").change(function() {
		var optionSelected = $("option:selected", this);
		$("#countryCode").html(optionSelected.data("code"));
	})

	// $("#referal").on("input propertychange paste", function() {
	//   if ($(this).val()) {
	//     var data = {
	//       referal: $(this).val()
	//     };
	//     $.ajax({
	//       type: "GET",
	//       url: "/check-referal",
	//       data: data,
	//       dataType: "json",
	//       success: function(data) {
	//         if (data.status == "error") {
	//           toastr.warning(data.message, "Error")
	//           $("#referal").val("")
	//           $("#sponser_id").val("")
	//           $("#placement_id_left").val("")
	//           $("#placement_id_right").val("")
	//           $("#referal").focus()
	//         } else {
	//           $("#sponser_id").val(data.data.sponser_id)
	//           $("#placement_id_left").val(data.data.placement_user_left_id)
	//           $("#placement_id_right").val(data.data.placement_user_right_id)
	//         }
	//       }
	//     });
	//   }
	// });

	window.checkReferal = function($el, value, callback) {
		var data = {
			referal: value
		};
		$.ajax({
			type: "GET",
			url: "/check-referal",
			data: data,
			dataType: "json",
			success: function(data) {
				if (data.status == "error") {
					callback({
						value: value,
						valid: false,
						message: data.message
					});
					//$("#referal").val("")
					$("#sponser_id").val("")
					$("#placement_id_left").val("")
					$("#placement_id_right").val("")
					$("#placement_position").val("L")
					$("#referal").focus()
				} else {
					$("#sponser_id").val(data.data.sponser_id)
					$("#placement_position").val("L")
					$("#placement_id_left").show().val(data.data.placement_user_left_id)
					$("#placement_id_right").hide().val(data.data.placement_user_right_id)
					$("#sponcer_container").removeClass("hidden")
					callback({
						value: value,
						valid: true,
						message: data.message
					});
				}
			}
		});
	}

	// $("#placement_id_left").on("focusout", function() {
	//   var data = {
	//     "referal": $("#referal").val(),
	//     "placement_id": $(this).val(),
	//     "position": "left"
	//   }
	//   checkPlacement(data)
	// })

	// $("#placement_position").change(function(){
	//   var position = $(this).val();
	//   var placement_id = "";
	//   if(position == 'L') {
	//     placement_id = $("#placement_id_left").val()
	//   } else {
	//     placement_id = $("#placement_id_right").val()
	//   }
	//   var data = {
	//     "referal": $("#referal").val(),
	//     "placement_id": placement_id,
	//     "position": position
	//   }
	//   checkPlacement(data)
	// })

	// $("#placement_id_right").on("focusout", function() {
	//   var data = {
	//     "referal": $("#referal").val(),
	//     "placement_id": $(this).val(),
	//     "position": "right"
	//   }
	//   checkPlacement(data)
	// })

	window.checkPlacement = function($el, value, callback) {
		var data = {};

		if($el.attr("id") === "placement_id_left" || $el.attr("id") === "placement_id_right") {
			var data = {
				"referal": $("#referal").val(),
				"placement_id": value,
				"position": $("#placement_position").val()
			}
		} else if ($el.attr("id") === "placement_position") {
			var placement_id = "";
			if(value == 'L') {
				placement_id = $("#placement_id_left").val()
			} else {
				placement_id = $("#placement_id_right").val()
			}
			var data = {
				"referal": $("#referal").val(),
				"placement_id": placement_id,
				"position": value
			}
		}

		$.ajax({
			type: "GET",
			url: "/check-placement",
			data: data,
			dataType: "json",
			success: function(response) {
				if (response.status == "error") {
					callback({
						value: value,
						valid: false,
						message: response.message
					});
				} else {
					$("#basic_info").removeClass('hidden');
					callback({
						value: value,
						valid: true
					});
				}
			}
		});
	}

	$("input,select,textarea")
        .not("[type=submit]")
        .jqBootstrapValidation({
            submitSuccess: function($form, event) {
                var formId = $form.attr("id");
                var data = getFormData($form);
                if (formId == "registerForm") {
                    registerFormAjax(event, data);
                } else if (formId == "forgotPasswordForm") {
                    forgotPasswordAjax(event, data)
                } else if (formId == "loginForm") {
                    loginFormAjax(event, data);
                } else {
                    otpLoginFormAjax(event, data);
                }
            }
        });

	$("#referal_yes,#referal_no").click(function(event){
		var confirmatiom = event.target.id;
		if(confirmatiom =='referal_yes'){
			$("#referal_confirmation_container").addClass('hidden');
			$("#referal_container").removeClass('hidden');
		} else {
			$("#referal_confirmation_container").addClass('hidden');
			$("#basic_info").removeClass('hidden');
		}
	}); 

	$("#placement_yes,#placement_no").click(function(event){
		var confirmatiom = event.target.id;
		if(confirmatiom =='placement_no'){
			$("#placement_confirmation_container").addClass('hidden');
			$("#placement_container").removeClass('hidden');
			$("#placement_id_left").attr('disabled',true);
			$("#placement_id_right").attr('disabled',true);
			$("#basic_info").removeClass('hidden');
		} else {
			$("#placement_confirmation_container").addClass('hidden');
			$("#placement_container").removeClass('hidden');
			$("#placement_id_left").val('');
			$("#placement_id_right").val('');
		}
	});
});
