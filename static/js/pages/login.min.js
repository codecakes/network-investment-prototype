$(document).ready(function() {
  function getFormData($form) {
    var unindexed_array = $form.serializeArray();
    var indexed_array = {};

    $.map(unindexed_array, function(n, i) {
      indexed_array[n["name"]] = n["value"];
    });

    return indexed_array;
  }

  function loginFormAjax(event, data) {
    event.preventDefault();
    $.ajax({
      type: "POST",
      url: "",
      data: data,
      success: function(data) {
        data = JSON.parse(data);
        if (data.status == "error") {
          toastr.warning(data.message, "Error");
        } else if (data.status == "ok") {
          window.location = "home";
        }
      }
    });
  }

  function registerFormAjax(event, data) {
    event.preventDefault();
    $.ajax({
      type: "POST",
      url: "/signup/",
      data: data,
      success: function(data) {
        data = JSON.parse(data)
        if(data.status == "error") {
          toastr.warning(data.message, "Error");
        } else {
          toastr.success(data.message, "Success");
        }
        // toastr.success(data, "Success");
        // setTimeout(function() {
        //   window.location.reload();
        // }, 500);
      }
    });
  }

  function forgotPasswordAjax(event, data) {
    event.preventDefault();
    $.ajax({
      type: "POST",
      url: "",
      data: data,
      success: function(data) {
        data = JSON.parse(data)
        if (data.status == "error") {
          toastr.warning(data.message, "Error");
        } else if (data.status == "ok") {
          toastr.success(data.message, "Success");
        }
      }
    });
  }

  $("#placement_position").change(function() {
    if ($(this).val() == "R") {
      $("#placement_id_right").css("display", "block");
      $("#placement_id_left").css("display", "none");
    } else {
      $("#placement_id_right").css("display", "none");
      $("#placement_id_left").css("display", "block");
    }
  });

  $("#referal").on("input propertychange paste", function() {
    if ($(this).val()) {
      var data = {
        referal: $(this).val()
      };
      $.ajax({
        type: "GET",
        url: "/check-referal",
        data: data,
        dataType: "json",
        success: function(data) {
          if (data.status == "error") {
            toastr.warning(data.message, "Error")
            $("#referal").val("")
            $("#sponser_id").val("")
            $("#placement_id_left").val("")
            $("#placement_id_right").val("")
            $("#referal").focus()
          } else {
            $("#sponser_id").val(data.data.sponser_id)
            $("#placement_id_left").val(data.data.placement_user_left_id)
            $("#placement_id_right").val(data.data.placement_user_right_id)
          }
        }
      });
    }
  });

  // $("#placement_id_left").on("focusout", function() {
  //   var data = {
  //     "referal": $("#referal").val(),
  //     "placement_id": $(this).val(),
  //     "position": "left"
  //   }
  //   checkPlacement(data)
  // })

  // $("#placement_position").change(function(){
  //   var position = $(this).val();
  //   var placement_id = "";
  //   if(position == 'L') {
  //     placement_id = $("#placement_id_left").val()
  //   } else {
  //     placement_id = $("#placement_id_right").val()
  //   }
  //   var data = {
  //     "referal": $("#referal").val(),
  //     "placement_id": placement_id,
  //     "position": position
  //   }
  //   checkPlacement(data)
  // })

  // $("#placement_id_right").on("focusout", function() {
  //   var data = {
  //     "referal": $("#referal").val(),
  //     "placement_id": $(this).val(),
  //     "position": "right"
  //   }
  //   checkPlacement(data)
  // })

  window.checkPlacement = function($el, value, callback) {
    // callback({
    //   value: value,
    //   valid: /a.*z/.test(value),
    //   message: "Must start with 'a' and end with 'z'"
    // });

    var data = {};

    if($el.attr("id") === "placement_id_left" || $el.attr("id") === "placement_id_right") {
      var data = {
        "referal": $("#referal").val(),
        "placement_id": value,
        "position": $("#placement_position").val()
      }
    } else if ($el.attr("id") === "placement_position") {
      var placement_id = "";
      if(value == 'L') {
        placement_id = $("#placement_id_left").val()
      } else {
        placement_id = $("#placement_id_right").val()
      }
      var data = {
        "referal": $("#referal").val(),
        "placement_id": placement_id,
        "position": value
      }
    }

    $.ajax({
      type: "GET",
      url: "/check-placement",
      data: data,
      dataType: "json",
      success: function(response) {
        console.log(response)
        if (response.status == "error") {
          callback({
            value: value,
            valid: false,
            message: response.message
          });
          // $("#register_form_submit").prop('disabled', true);
          // toastr.warning(response.message, "Error")
        } else {
          // $("#register_form_submit").prop('disabled', false);
          callback({
            value: value,
            valid: true,
            // message: response.message
          });
        }
      }
    });
  }

  $("input,select,textarea")
    .not("[type=submit]")
    .jqBootstrapValidation({
      submitSuccess: function($form, event) {
        var formId = $form.attr("id");
        var data = getFormData($form);
        if (formId == "registerForm") {
          registerFormAjax(event, data);
        } else if (formId == "forgotPasswordForm") {
          forgotPasswordAjax(event, data)
        } else {
          loginFormAjax(event, data);
        }
      }
    });
});
